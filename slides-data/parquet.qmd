---
title: "Le format de donn√©es `Parquet`"
subtitle: "Ateliers du SSPHub #2"
author:
    - Lino Galiana
description: "Slides pr√©sentant les enjeux de l'utilisation du format `Parquet` et l'√©cosyst√®me associ√©"
date: "2025-04-16"
date-format: long
slide-number: true
footer: |
  Ateliers du SSPHub #2
lang: fr-FR
chalkboard: # press the B key to toggle chalkboard
  theme: whiteboard
format: onyxia-revealjs
controls: true
css: custom.css
from: markdown+emoji
image: "/img/librairies2.png"
priority: 1
---

## "The obligatory intro slide"

![Source : [motherduck.com](https://motherduck.com/blog/big-data-is-dead/)](https://motherduck.com/_next/image/?url=https%3A%2F%2Fweb-assets-prod.motherduck.com%2Fassets%2Fimg%2Fimage_2_0f68796072.jpg&w=1920&q=75){fig-align="center" height=400}

## Enjeux

- Tendance √† la [**massification**]{.orange} des donn√©es
    - Relatif aux [**capacit√©s de stockage et de traitement**]{.blue2}

. . .

![Source : [AI with Python](https://www.packtpub.com/product/artificial-intelligence-with-python-second-edition/9781839219535)](https://ensae-reproductibilite.github.io/slides/img/vvv.png){fig-align="center" height=350}

## Pour traiter la volum√©trie

- Utiliser un [**format**]{.orange} de donn√©es adapt√© (`Parquet`)

. . .

- Utiliser des [**outils**]{.orange} informatiques adapt√©s
  - Suffisant la plupart du temps : [**calcul *larger than memory* optimis√©**]{.blue2} (`Arrow` / `DuckDB`)
  - Si volum√©trie massive : [**calcul distribu√©**]{.blue2} (`Spark`)

. . .


- Utiliser une [**infra de stockage**]{.orange} adapt√©e (`S3`)

. . .

::: {.callout-note}
Nous allons voir comment ces trois points sont compl√©mentaires.
:::

## "Big Data is dead" ?

* Jordan Tigani : [Big Data is dead](https://motherduck.com/blog/big-data-is-dead/)
    - _"The big data frontier keeps receding"_
    - _"Most people don't have that much data"_
    - _"Most data is rarely queried"_


. . .

- Plaidoyer pour une [**parcimonie**]{.orange}...
    - ... qui [**facilite la mise en production**]{.blue2} !


# Pourquoi le format `Parquet` ?

## Enjeux

- Le choix d'un format de donn√©es r√©pond √† un [**arbitrage**]{.orange} entre plusieurs crit√®res :
  - [**Public cible**]{.blue2}
  - [**Finalit√©**]{.blue2} (traitement, analyse, diffusion)
  - [**Volum√©trie**]{.blue2}
  - [**Interop√©rabilit√©**]{.blue2}

## Formats traditionnels

- Formats de donn√©es adh√©rents √† un langage ([**sas7bdat**]{.orange}, [**RDS**]{.orange}, [**fst**]{.orange}, etc.)
  - [**Non-interop√©rables**]{.blue2} -> √† √©viter !

. . .

- Le format [**CSV**]{.orange}
  - [**Interop√©rable**]{.blue2} et [**simple**]{.blue2} d'utilisation
  - Pas de gestion des [**m√©ta-donn√©es**]{.blue2}
  - Peu adapt√© aux [**donn√©es volumineuses**]{.blue2}

## Limites du `CSV` {.incremental}

:::: {.columns}

::: {.column width=70%}

- Des [**performances limit√©es**]{.orange}
  - [**Stockage**]{.blue2} : non-compress√© -> [**espace disque √©lev√©**]{.blue2}
  - [**Lecture**]{.blue2} : "orient√©-ligne" -> [**performances faibles**]{.blue2}

:::

::: {.column width=30%}


![](images/parquet-table1.png){fig-align="center"}

:::


- **[Pas de typage]{.orange}** des donn√©es √† l'√©criture du fichier
  - Demande expertise et pr√©caution √† la lecture
  - Exemple: <b><ins>01</ins>004</b> pour le code commune d'Amb√©rieu-en-Bugey

::::

# Les avantages du format `Parquet`

## Un format l√©ger {{< iconify fe feather color=#0f8c18 >}}

- [**Stockage**]{.orange} :
    - [**Compression**]{.blue2} : entre 5 et 20 fois plus l√©ger qu'un CSV


. . .

::: {.nonincremental}
::::: {.callout-note}
## Exemple: Recensement de la Population

- [Ficher d√©tail](https://www.insee.fr/fr/statistiques/8268848?sommaire=8205966) : 20 millions de lignes, 92 variables
    - CSV: > 4Go
    - Parquet: < 500Mo
:::::
:::

## Un format efficace

- [**Lecture**]{.orange} :
    - Jusqu‚Äô√† 34x plus rapide qu‚Äôun CSV

. . .

- [**"Orient√© colonne"**]{.orange}
  - Optimis√© pour les [**traitements analytiques**]{.blue2}
  - Limite la quantit√© de donn√©es √† mettre en m√©moire
  - Con√ßu pour √™tre √©crit une fois mais lu fr√©quemment

. . .

![](/slides-data/images/parquet-read-columns.png){fig-align="center"}

## Pour optimiser la lecture

- [**Partitionner**]{.orange} ou [**ordonner**]{.orange} les donn√©es


![](https://ensae-reproductibilite.github.io/slides/img/partitions.png){fig-align="center" height="230"}

::: {.nonincremental}
::::: {.callout-warning}
## L'art de bien partitionner

- Partitionner par une/des [**variable(s) d'int√©r√™t**]{.blue2} si gros fichier
    + [**Eviter**]{.blue2} de cr√©er de [**nombreux petits (< 128Mo) fichiers**]{.blue2}
- Sinon ordonner les donn√©es avant d'√©crire le fichier (cf. [Eric Mauvi√®re](https://www.icem7.fr/outils/comment-bien-preparer-son-parquet/))

:::::
:::

## Un format universel et fiable

- Gestion native des [**m√©ta-donn√©es**]{.orange}
  - D√©finition automatique d'un [**sch√©ma**]{.blue2} (noms, types)
  - Mise √† disposition plus [**robuste**]{.blue2}

. . .

- [**Interop√©rable**]{.orange}

. . .

- [**Open-source**]{.orange}

. . .

- Non lisible par un humain mais de plus en plus de visualiseurs en ligne
    - Par exemple sur le [SSPCloud](https://datalab.sspcloud.fr/data-explorer) {{< fa solid dragon >}}

# Du point de vue d'un producteur de donn√©es

## `Parquet`: quels avantages ?

* Format libre, _open source_ et [__ind√©pendant du langage__]{.orange} ;
  * Les formats propri√©taires imposent des outils aux consommateurs !

* __[Plus de confort]{.orange}__ pour les utilisateurs:
  * Des [requ√™tes plus rapides et efficaces]{.blue2}: seulement les donn√©es n√©cessaires sont lues
  * Des [donn√©es conformes]{.blue2} √† la mise √† disposition par le producteur

## `Parquet`: quels usages ?

* Format privil√©gi√© pour la mise √† disposition de donn√©es internes √† l‚ÄôInsee:
  * Moins d‚Äôasym√©tries entre utilisateurs et producteurs.


::: {.callout-note .nonincremental}
## Premi√®res diffusions √† l‚Äôexterne

- Bureaux de votes du **[__r√©pertoire √©lectoral unique__]{.blue2}** (REU):
- [__Recensement de la population__]{.blue2} (RP)
- [__Base permanente des √©quipements__]{.blue2} (BPE)

:::

## `Parquet`: quels usages ?

:::: {.columns}

::: {.column width=50%}

![](/slides-data/images/res_secondaires.png)

:::

::: {.column width=50%}

![](/slides-data/images/res_secondaires2.png)

:::

::::

_Exemples de cartes pouvant √™tre produites simplement avec les donn√©es du recensement diffus√©es par l'Insee_


# Exploiter un fichier `Parquet`

## Enjeu

* `Parquet` ne r√©sout pas tout
  * L‚Äôespace disque est optimis√©
  * Les donn√©es d√©compress√©es doivent __[passer en RAM]{.blue2}__

. . .

* Le framework adapt√© d√©pend de la [__volum√©trie__]{.orange}
  * Pour la plupart des besoins : `Arrow` et `DuckDB`


## Les frameworks

- Deux *frameworks* de r√©f√©rence : [Arrow](https://book.utilitr.org/03_Fiches_thematiques/Fiche_arrow.html) et [DuckDB](https://book.utilitr.org/03_Fiches_thematiques/Fiche_duckdb.html)
  - Orientation [**fichier**]{.blue2} (`Arrow`) VS orientation [**BDD**]{.blue2} (`DuckDB`)

. . .

- [**Traitement en-m√©moire optimis√©**]{.orange}
  - [**Orient√©s-colonne**]{.blue2}
  - [***Lazy evaluation***]{.blue2} (prochaine slide)

. . .

- Tr√®s bonne [**int√©gration**]{.blue2}:
  - Avec le `tidyverse` ({{< fa brands r-project >}})
  - Avec le syst√®me de stockage `S3`

## Les frameworks


![](https://linogaliana.github.io/parquet-recensement-tutomate-slides/img/librairies2.png){fig-align="center"}


## La lazy evaluation

* Les frameworks comme **[Arrow]{.orange}** ou **[DuckDB]{.orange}** n‚Äôex√©cutent pas imm√©diatement les op√©rations

. . .

* Les instructions sont **[optimis√©es avant ex√©cution]{.orange}**
    * Vous √©crivez un **[plan d'ex√©cution]{.blue2}**, r√©interpr√©t√©

. . .

* Avantages :
    * __[Moins de donn√©es]{.blue2}__ manipul√©es inutilement
    * __[Moins de RAM]{.blue2}__ consomm√©e
    * __[Ex√©cution plus rapide]{.blue2}__ car optimis√©e


## La lazy evaluation

::: {.nonincremental}
::::: {.callout-note}
## Exemple d'une requ√™te *lazy*

En supposant qu'`achille` est un objet `Arrow` ou `DuckDB`:

```{.r}
n_logements_depcom <- achille |>
  filter(dep %in% c("01", "02", "03")) |>  #<1>
  select(idlogement, depcom) |>  # <2>
  group_by(depcom) |>
  summarise(n_logements = n()) |>
  collect()  #<3>
```
1. R√©cup√®re seulement les donn√©es n√©cessaires
2. R√©cup√®re seulement les variables n√©cessaires
3. Les __[calculs ne sont effectu√©s qu'√† cette √©tape]{.orange}__ !

:::::
:::

## La lazy evaluation {.nonincremental}

* Voici le d√©but du plan:

![](/slides-data/images/lazyeval1.png)

‚ùìÔ∏è [_Pourrait-il √™tre optimis√© ?_]{.blue¬µ2}

## La lazy evaluation {.nonincremental}

* Voici le plan plus optimal:
  * [__Predicate pushdown__]{.orange}

![](/slides-data/images/lazyeval2.png)


## `Parquet` gagne sur tous les tableaux {.nonincremental}

![_Benchmarks_ faits pour la formation aux bonnes pratiques de l'Insee](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/slides/img/tableau-perf-parquet.png){fig-align="center" height="500"}


## Ressources compl√©mentaires

- Les posts d'Eric Mauvi√®re sur [icem7.fr/](https://www.icem7.fr/)

. . .

- [Webinaire du CASD](https://www.casd.eu/webinaire-casd-data-tech/) sur `Parquet` et `DuckDB`

. . .

- [La formation aux bonnes pratiques](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/) de l'Insee

. . .

- Un atelier de l'EHESS sur `Parquet` avec de nombreux exemples [ici](https://linogaliana.github.io/parquet-recensement-tutomate/)

. . .

- Le [cours de mise en production](https://ensae-reproductibilite.github.io/website/) de l'ENSAE

## Applications

![](/slides-data/images/comparatifs_exo.png)

## Ce n'est pas fini !

![](https://minio.lab.sspcloud.fr/lgaliana/generative-art/ssphub/tunes_chasing.jpg)


## Nouvelles opportunit√©s avec cet √©cosyst√®me

- [__Int√©gration native avec `S3`__]{.orange}
    - Pour [**travailler sur des serveurs √† l'√©tat de l'art**]{.blue2}...
    - Plut√¥t que sur des ordinateurs aux ressources limit√©es

. . .

- [DuckDB WASM](https://minio.lab.sspcloud.fr/lgaliana/generative-art/ssphub/tunes_chasing.jpg) pour faire du [__`DuckDB` dans le navigateur__]{.orange} :
    - Pour des [**_dataviz_ r√©actives**]{.blue2}... dans des [**sites statiques**]{.blue2} !
    - Bye bye les gal√®res de d√©ploiement de `Shiny`, `Streamlit`...


# Fonctionnalit√©s plus avanc√©es

## Les extensions spatiales

- Possibilit√© de lire/√©crire des [**objets g√©ographiques**]{.orange} dans `Parquet`
  - Compatible avec les standards `GeoParquet`
  - Extension `SPATIAL`

. . .

- Permet des traitements [**g√©ographiques efficaces**]{.blue2} :
  - Jointures spatiales, calculs de distance‚Ä¶
  - R√©cup√®re le r√©sultat sous `sf`


## Travailler avec `S3`

* Beaucoup plus simple qu'un _data warehouse_ et des VM `postgre`

. . .

* On peut lire la donn√©e sur `S3` _presque comme si_ elle √©tait en local

```{.python}
FROM 's3://bucket_name/filename.extension';
SELECT *
WHERE DEPT=='36'
```

## `DuckDB` dans le navigateur

- Gr√¢ce √† `DuckDB-WASM`, on peut ex√©cuter du SQL [**dans le navigateur**]{.orange} üéØ
  - Embarqu√© par d√©faut sur [`Observablehq`](https://observablehq.com/) et [`Quarto`](https://quarto.org/docs/interactive/ojs/)

. . .

- Id√©al pour des [**applications interactives**]{.orange} :
  - Visualisations r√©actives sur des [**sites statiques**]{.blue2} 
  - ‚ö° [**Pas besoin de serveur**]{.blue2} {{< fa brands r-project >}} ou {{< fa brands python >}}, tout est c√¥t√© client !


## Exemple


```{ojs}
//| echo: false
html`
  <div style="display: flex; flex-direction: column; gap: 1rem;">

    <!-- Search bar at the top -->
    <div>${viewof search}</div>

    <!-- Two-column block -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; backgroundColor: '#293845';">
      <div>${produce_histo(dvf)}</div>
      <div>${viewof table_dvf}</div>
    </div>


  </div>
`
```

{{< include "_interactive_parquet.qmd" >}}


```{ojs}
viewof table_dvf = Inputs.table(dvf, {columns: ["date", "valeur_fonciere"], rows: 15})

produce_histo = function(dvf){
  const histo = Plot.plot({
  style: {backgroundColor: "transparent"},
  marks: [
    Plot.rectY(dvf, Plot.binX({y: "count"}, {x: "valeur_fonciere", fill: "#ff562c"})),
    Plot.ruleY([0])
  ]
})
  return histo
}
```



## Des questions ?

![](https://minio.lab.sspcloud.fr/lgaliana/generative-art/pythonds/kid.png)